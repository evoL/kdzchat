// Generated by CoffeeScript 1.3.3
(function() {
  var ChatApp, Messages, UserList,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  this.User = (function(_super) {

    __extends(User, _super);

    function User() {
      return User.__super__.constructor.apply(this, arguments);
    }

    User.configure('User', 'id', 'nick', 'current');

    User.prototype.validate = function() {
      if (!this.nick.match(/^[\w\-]+$/)) {
        "The nick should only contain alphanumeric characters, hyphens and underscores";

      }
      if (User.findByAttribute('nick', this.nick)) {
        return 'This user already exists';
      }
    };

    return User;

  })(Spine.Model);

  this.Message = (function(_super) {

    __extends(Message, _super);

    function Message() {
      return Message.__super__.constructor.apply(this, arguments);
    }

    Message.configure('Message', 'authorId', 'content');

    Message.prototype.validate = function() {
      if (!User.exists(this.authorId)) {
        return "The user doesn't exist";
      }
    };

    return Message;

  })(Spine.Model);

  Messages = (function(_super) {

    __extends(Messages, _super);

    function Messages() {
      this.render = __bind(this.render, this);
      Messages.__super__.constructor.apply(this, arguments);
      this.el.addClass('post');
    }

    Messages.prototype.data = function() {
      return {
        author: User.find(this.message.authorId).nick,
        content: this.processMessage(this.message.content)
      };
    };

    Messages.prototype.processMessage = function(text) {
      var rx;
      rx = /((?:http|https):&#x2F;&#x2F;)?([a-z0-9-]+\.)?[a-z0-9-]+(\.[a-z]{2,6}){1,3}(&#x2F;(?:[a-z0-9.,_~#&=;%+?-]|&#x2F;)*)?/ig;
      return Mustache.escape(text).replace(rx, function(match, protocol) {
        var url;
        url = protocol != null ? match : "//" + match;
        return "<a href=\"" + url + "\" target=\"_blank\">" + match + "</a>";
      });
    };

    Messages.prototype.render = function() {
      this.html(Mustache.render($('#MessageTemplate').text(), this.data()));
      return this;
    };

    return Messages;

  })(Spine.Controller);

  UserList = (function(_super) {

    __extends(UserList, _super);

    function UserList() {
      this.render = __bind(this.render, this);
      UserList.__super__.constructor.apply(this, arguments);
      User.bind('refresh change', this.render);
    }

    UserList.prototype.data = function() {
      var _this = this;
      return {
        count: User.count(),
        users: User.all().map(function(user) {
          return {
            current: user.current,
            name: user.nick
          };
        })
      };
    };

    UserList.prototype.render = function() {
      this.html(Mustache.render($('#UserListTemplate').text(), this.data()));
      return this;
    };

    return UserList;

  })(Spine.Controller);

  ChatApp = (function(_super) {

    __extends(ChatApp, _super);

    ChatApp.prototype.elements = {
      '#ChatInput': 'input',
      '#ChatArea': 'posts',
      '.chatarea-wrapper': 'scrollArea',
      '#UserList': 'userlist'
    };

    ChatApp.prototype.events = {
      'submit #InputForm': 'submit'
    };

    function ChatApp() {
      this.addMessage = __bind(this.addMessage, this);

      var _this = this;
      ChatApp.__super__.constructor.apply(this, arguments);
      Message.bind('create', this.addMessage);
      this.users = new UserList({
        el: this.userlist
      });
      this.socket = io.connect();
      this.socket.on('connect', function() {
        return _this.socket.emit('add user', {
          nick: _this.randomizeNick()
        }, function(data, users) {
          var uid, userdata, _results;
          _this.user = User.create({
            id: data.id,
            nick: data.nick,
            current: true
          });
          _results = [];
          for (uid in users) {
            userdata = users[uid];
            if (uid !== data.id) {
              _results.push(User.create({
                id: userdata.id,
                nick: userdata.nick,
                current: false
              }));
            } else {
              _results.push(void 0);
            }
          }
          return _results;
        });
      });
      this.socket.on('user connected', function(data) {
        data.current = false;
        if (!User.exists(data.id)) {
          return User.create(data);
        }
      });
      this.socket.on('user disconnected', function(uid) {
        return User.destroy(uid);
      });
      this.socket.on('chat', function(msg) {
        return Message.create(msg);
      });
    }

    ChatApp.prototype.submit = function(e) {
      e.preventDefault();
      Message.create({
        authorId: this.user.id,
        content: this.input.val()
      });
      this.socket.emit('chat', {
        content: this.input.val()
      });
      return this.input.val('');
    };

    ChatApp.prototype.addMessage = function(msg) {
      var view;
      view = new Messages({
        message: msg
      });
      this.posts.append(view.render().el);
      return this.scrollArea.scrollTop(this.scrollArea.height());
    };

    ChatApp.prototype.randomizeNick = function() {
      var index;
      index = Math.floor(Math.random() * 100000);
      return "guest" + index;
    };

    return ChatApp;

  })(Spine.Controller);

  $(function() {
    return new ChatApp({
      el: $('#Viewport')
    });
  });

}).call(this);
